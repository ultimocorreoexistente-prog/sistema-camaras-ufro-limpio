#!/bin/bash
set -e  # Detener si hay error

echo "ğŸ”§ Iniciando despliegue en Railway..."

# 1. Verificar SECRET_KEY (obligatorio en producciÃ³n)
if [ -z "$SECRET_KEY" ]; then
  echo "âŒ ERROR: SECRET_KEY no estÃ¡ definida en variables de entorno"
  echo "ğŸ’¡ En Railway: Project â†’ Variables â†’ AÃ±ade SECRET_KEY con una clave aleatoria"
  exit 1
fi

# 2. Verificar DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
  echo "âŒ ERROR: DATABASE_URL no estÃ¡ definida"
  echo "ğŸ’¡ Railway deberÃ­a inyectarla automÃ¡ticamente si tienes PostgreSQL vinculado"
  exit 1
fi

echo "âœ… SECRET_KEY y DATABASE_URL detectadas"

# 3. Ejecutar inicializaciÃ³n de la base de datos
echo "ğŸ”„ Inicializando base de datos..."
python -c "
from app import app
from models import db
with app.app_context():
    try:
        db.create_all()
        print('âœ… Tablas creadas o verificadas exitosamente')
    except Exception as e:
        print('âŒ Error al crear tablas:')
        print(e)
        exit(1)
"

# 4. Iniciar la aplicaciÃ³n
echo "ğŸš€ Iniciando aplicaciÃ³n con gunicorn..."
exec gunicorn app:app --workers 1 --timeout 60 --bind 0.0.0.0:$PORT