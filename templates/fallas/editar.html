{% extends "base.html" %}

{% block title %}Editar Falla #{{ falla.id }}{% endblock %}

{% block extra_css %}
<style>
.form-section {
border: 1px solid #deee6;
border-radius: 8px;
margin-bottom: 1.5rem;
}

.form-section-header {
background: #f8f9fa;
border-bottom: 1px solid #deee6;
padding: 1rem;
border-radius: 8px 8px 0 0;
}

.form-section-body {
padding: 1.5rem;
}

.gravedad-option {
border: px solid transparent;
border-radius: 8px;
padding: 1rem;
cursor: pointer;
transition: all 0.3s ease;
}

.gravedad-option:hover {
border-color: #007bff;
background-color: #f8f9ff;
}

.gravedad-option.selected {
border-color: #007bff;
background-color: #e3ffd;
}

.gravedad-option.current {
border-color: #8a745;
background-color: #d4edda;
}

.gravedad-critical { border-left: 4px solid #dc3545; }
.gravedad-alta { border-left: 4px solid #fd7e14; }
.gravedad-media { border-left: 4px solid #ffc107; }
.gravedad-baja { border-left: 4px solid #8a745; }

.estado-option {
border: px solid #deee6;
border-radius: 8px;
padding: 1rem;
cursor: pointer;
transition: all 0.3s ease;
}

.estado-option:hover {
border-color: #007bff;
background-color: #f8f9ff;
}

.estado-option.selected {
border-color: #007bff;
background-color: #e3ffd;
}

.estado-option.current {
border-color: #8a745;
background-color: #d4edda;
}

.historial-ediciones {
background: #f8f9fa;
border-radius: 8px;
max-height: 400px;
overflow-y: auto;
}

.cambio-item {
border-left: 3px solid #007bff;
padding-left: 1rem;
margin-bottom: 1rem;
}

.cambio-item.critico {
border-left-color: #dc3545;
}

.upload-zone {
border: px dashed #007bff;
border-radius: 8px;
padding: rem;
text-align: center;
background-color: #f8f9fa;
transition: all 0.3s ease;
}

.upload-zone:hover {
background-color: #e9ecef;
border-color: #0056b3;
}

.upload-zone.dragover {
background-color: #e3ffd;
border-color: #196f3;
}

.estadisticas-falla {
background: linear-gradient(135deg, #667eea 0%, #764ba 100%);
color: white;
border-radius: 8px;
padding: 1.5rem;
}

.costo-input {
border: px solid #deee6;
border-radius: 8px;
padding: 0.75rem;
font-size: 1.1rem;
font-weight: bold;
}

.costo-input:focus {
border-color: #007bff;
box-shadow: 0 0 0 0.rem rgba(0, 13, 55, 0.5);
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
<div>
<h1 class="h3 mb-0">
<i class="bi bi-pencil-square text-primary"></i>
Editar Falla #{{ falla.id }}
</h1>
<p class="text-muted mb-0">{{ falla.descripcion[:80] }}{% if falla.descripcion|length > 80 %}...{% endif %}</p>
</div>
<div>
<a href="{{ url_for('fallas_detalle', falla_id=falla.id) }}" class="btn btn-outline-secondary me-">
<i class="bi bi-arrow-left"></i> Volver al Detalle
</a>
<a href="{{ url_for('fallas_listar') }}" class="btn btn-outline-secondary">
<i class="bi bi-list"></i> Lista de Fallas
</a>
</div>
</div>

<form method="POST" id="formFalla" enctype="multipart/form-data" novalidate>
<-- Información actual de la falla -->
<div class="estadisticas-falla mb-4">
<div class="row">
<div class="col-md-3 text-center">
<i class="bi bi-calendar-plus fs-1"></i>
<h5 class="mt-">Fecha Reporte</h5>
<p class="mb-0">{{ falla.fecha_reporte.strftime('%d/%m/%Y %H:%M') if falla.fecha_reporte else 'N/A' }}</p>
</div>
<div class="col-md-3 text-center">
<i class="bi bi-clock fs-1"></i>
<h5 class="mt-">Tiempo Transcurrido</h5>
<p class="mb-0">
{% set tiempo_transcurrido = (datetime.now() - falla.fecha_reporte).days if falla.fecha_reporte else 0 %}
{{ tiempo_transcurrido }} días
</p>
</div>
<div class="col-md-3 text-center">
<i class="bi bi-person fs-1"></i>
<h5 class="mt-">Reportado por</h5>
<p class="mb-0">{{ falla.usuario_reporta.nombre_completo if falla.usuario_reporta else 'Sistema' }}</p>
</div>
<div class="col-md-3 text-center">
<i class="bi bi-currency-dollar fs-1"></i>
<h5 class="mt-">Costo Actual</h5>
<p class="mb-0">${{ "{:,.f}".format(falla.costo) if falla.costo else '0.00' }}</p>
</div>
</div>
</div>

<div class="row">
<-- Formulario principal -->
<div class="col-lg-8">
<div class="form-section">
<div class="form-section-header">
<h5 class="mb-0">
<i class="bi bi-info-circle"></i> Información Básica
</h5>
</div>
<div class="form-section-body">
<div class="row">
<div class="col-md-6 mb-3">
<label for="equipo_id" class="form-label required-field">Equipo Afectado</label>
<select name="equipo_id" id="equipo_id" class="form-select" required>
<option value="">Seleccionar equipo...</option>
{% for equipo in equipos %}
<option value="{{ equipo.id }}"
data-tipo="{{ equipo.tipo or '' }}"
data-ubicacion="{{ equipo.ubicacion or '' }}"
{% if equipo.id == falla.equipo_id %}selected{% endif %}>
{{ equipo.nombre or 'Equipo ' + equipo.id|string }} ({{ equipo.tipo or 'Sin tipo' }})
</option>
{% endfor %}
</select>
<div class="invalid-feedback">Por favor seleccione un equipo.</div>
</div>

<div class="col-md-6 mb-3">
<label for="gravedad" class="form-label required-field">Nivel de Gravedad</label>
<select name="gravedad" id="gravedad" class="form-select" required>
<option value="">Seleccionar gravedad...</option>
<option value="critica" {% if falla.gravedad == 'critica' %}selected{% endif %}>Crítica - Afecta operación completa</option>
<option value="alta" {% if falla.gravedad == 'alta' %}selected{% endif %}>Alta - Afecta funcionalidad principal</option>
<option value="media" {% if falla.gravedad == 'media' %}selected{% endif %}>Media - Afecta funcionalidad secundaria</option>
<option value="baja" {% if falla.gravedad == 'baja' %}selected{% endif %}>Baja - Problema menor</option>
</select>
<div class="invalid-feedback">Por favor seleccione el nivel de gravedad.</div>
</div>
</div>

<div class="row">
<div class="col-md-6 mb-3">
<label for="estado" class="form-label required-field">Estado Actual</label>
<select name="estado" id="estado" class="form-select" required>
<option value="">Seleccionar estado...</option>
<option value="reportada" {% if falla.estado == 'reportada' %}selected{% endif %}>Reportada</option>
<option value="en_proceso" {% if falla.estado == 'en_proceso' %}selected{% endif %}>En Proceso</option>
<option value="resuelta" {% if falla.estado == 'resuelta' %}selected{% endif %}>Resuelta</option>
<option value="cerrada" {% if falla.estado == 'cerrada' %}selected{% endif %}>Cerrada</option>
</select>
<div class="invalid-feedback">Por favor seleccione el estado.</div>
</div>

<div class="col-md-6 mb-3">
<label for="costo" class="form-label">Costo de Reparación</label>
<div class="input-group">
<span class="input-group-text">$</span>
<input type="number" name="costo" id="costo" class="form-control costo-input"
value="{{ falla.costo or '' }}" min="0" step="0.01" placeholder="0.00">
</div>
<div class="form-text">Costo total de la reparación incluyendo mano de obra y materiales.</div>
</div>
</div>

<div class="mb-3">
<label for="descripcion" class="form-label required-field">Descripción de la Falla</label>
<textarea name="descripcion" id="descripcion" class="form-control" rows="4" required>{{ falla.descripcion }}</textarea>
<div class="invalid-feedback">Por favor proporcione una descripción de la falla.</div>
<div class="form-text">
<span id="char-count">{{ falla.descripcion|length }}</span>/500 caracteres.
</div>
</div>

<div class="mb-3">
<label for="solucion" class="form-label">Solución Aplicada</label>
<textarea name="solucion" id="solucion" class="form-control" rows="4"
placeholder="Describa la solución aplicada para resolver la falla...">{{ falla.solucion or '' }}</textarea>
<div class="form-text">
<span id="solucion-count">{{ falla.solucion|length if falla.solucion else 0 }}</span>/500 caracteres.
</div>
</div>

<div class="mb-3">
<label for="comentarios" class="form-label">Comentarios Adicionales</label>
<textarea name="comentarios" id="comentarios" class="form-control" rows="3"
placeholder="Información adicional, observaciones, contexto...">{{ falla.comentarios or '' }}</textarea>
<div class="form-text">
<span id="comentarios-count">{{ falla.comentarios|length if falla.comentarios else 0 }}</span>/300 caracteres.
</div>
</div>
</div>
</div>

<-- Asignación y Fechas -->
<div class="form-section">
<div class="form-section-header">
<h5 class="mb-0">
<i class="bi bi-person-check"></i> Asignación y Fechas
</h5>
</div>
<div class="form-section-body">
<div class="row">
<div class="col-md-6 mb-3">
<label for="tecnico_asignado_id" class="form-label">Técnico Asignado</label>
<select name="tecnico_asignado_id" id="tecnico_asignado_id" class="form-select">
<option value="">Sin asignar</option>
{% for tecnico in tecnicos %}
<option value="{{ tecnico.id }}"
{% if falla.tecnico_asignado_id == tecnico.id %}selected{% endif %}>
{{ tecnico.nombre_completo }} ({{ tecnico.especialidad or 'General' }})
</option>
{% endfor %}
</select>
</div>

<div class="col-md-6 mb-3">
<label for="fecha_estimada_resolucion" class="form-label">Fecha Estimada de Resolución</label>
<input type="datetime-local" name="fecha_estimada_resolucion" id="fecha_estimada_resolucion"
class="form-control" value="{{ falla.fecha_estimada_resolucion.strftime('%Y-%m-%dT%H:%M') if falla.fecha_estimada_resolucion else '' }}">
</div>
</div>

{% if falla.fecha_resolucion %}
<div class="row">
<div class="col-md-6">
<small class="text-muted">
<i class="bi bi-calendar-check"></i> <strong>Fecha Resolución:</strong><br>
{{ falla.fecha_resolucion.strftime('%d/%m/%Y %H:%M') }}
</small>
</div>
</div>
{% endif %}
</div>
</div>

<-- Subir evidencias adicionales -->
<div class="form-section">
<div class="form-section-header">
<h5 class="mb-0">
<i class="bi bi-paperclip"></i> Evidencias Adicionales (Opcional)
</h5>
</div>
<div class="form-section-body">
<div class="upload-zone" id="upload-zone">
<i class="bi bi-cloud-upload fs-1 text-muted mb-3"></i>
<h5>Arrastre archivos aquí o haga clic para seleccionar</h5>
<p class="text-muted mb-3">
Formatos aceptados: JPG, PNG, GIF (máx. 5MB cada uno)
</p>
<input type="file" name="evidencias" id="evidencias" class="d-none" multiple accept="image/*">
<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('evidencias').click()">
<i class="bi bi-folder-open"></i> Seleccionar Archivos
</button>
</div>

<div id="preview-evidencias" class="row mt-3"></div>
</div>
</div>
</div>

<-- Sidebar -->
<div class="col-lg-4">
<-- Opciones de Gravedad -->
<div class="card mb-4">
<div class="card-header">
<h6 class="mb-0">
<i class="bi bi-exclamation-triangle"></i> Nivel de Gravedad
</h6>
</div>
<div class="card-body">
{% set gravedad_actual = falla.gravedad %}
<div class="gravedad-option gravedad-critical mb- {% if gravedad_actual == 'critica' %}current{% endif %}" data-gravedad="critica">
<div class="d-flex align-items-center">
<i class="bi bi-exclamation-octagon fs-4 me-3 text-danger"></i>
<div>
<h6 class="mb-1">Crítica</h6>
<small class="text-muted">Sistema completamente fuera de servicio</small>
</div>
</div>
</div>

<div class="gravedad-option gravedad-alta mb- {% if gravedad_actual == 'alta' %}current{% endif %}" data-gravedad="alta">
<div class="d-flex align-items-center">
<i class="bi bi-exclamation-triangle fs-4 me-3 text-warning"></i>
<div>
<h6 class="mb-1">Alta</h6>
<small class="text-muted">Funcionalidad principal afectada</small>
</div>
</div>
</div>

<div class="gravedad-option gravedad-media mb- {% if gravedad_actual == 'media' %}current{% endif %}" data-gravedad="media">
<div class="d-flex align-items-center">
<i class="bi bi-info-circle fs-4 me-3 text-info"></i>
<div>
<h6 class="mb-1">Media</h6>
<small class="text-muted">Funcionalidad secundaria afectada</small>
</div>
</div>
</div>

<div class="gravedad-option gravedad-baja {% if gravedad_actual == 'baja' %}current{% endif %}" data-gravedad="baja">
<div class="d-flex align-items-center">
<i class="bi bi-check-circle fs-4 me-3 text-success"></i>
<div>
<h6 class="mb-1">Baja</h6>
<small class="text-muted">Problema menor</small>
</div>
</div>
</div>
</div>
</div>

<-- Opciones de Estado -->
<div class="card mb-4">
<div class="card-header">
<h6 class="mb-0">
<i class="bi bi-circle"></i> Estado Actual
</h6>
</div>
<div class="card-body">
{% set estado_actual = falla.estado %}
<div class="estado-option mb- {% if estado_actual == 'reportada' %}current{% endif %}" data-estado="reportada">
<div class="d-flex align-items-center">
<i class="bi bi-circle fs-4 me-3 text-secondary"></i>
<div>
<h6 class="mb-1">Reportada</h6>
<small class="text-muted">Falla recién reportada</small>
</div>
</div>
</div>

<div class="estado-option mb- {% if estado_actual == 'en_proceso' %}current{% endif %}" data-estado="en_proceso">
<div class="d-flex align-items-center">
<i class="bi bi-clock fs-4 me-3 text-warning"></i>
<div>
<h6 class="mb-1">En Proceso</h6>
<small class="text-muted">Técnico trabajando en la falla</small>
</div>
</div>
</div>

<div class="estado-option mb- {% if estado_actual == 'resuelta' %}current{% endif %}" data-estado="resuelta">
<div class="d-flex align-items-center">
<i class="bi bi-check-circle fs-4 me-3 text-success"></i>
<div>
<h6 class="mb-1">Resuelta</h6>
<small class="text-muted">Problema solucionado</small>
</div>
</div>
</div>

<div class="estado-option {% if estado_actual == 'cerrada' %}current{% endif %}" data-estado="cerrada">
<div class="d-flex align-items-center">
<i class="bi bi-check-circle-fill fs-4 me-3 text-primary"></i>
<div>
<h6 class="mb-1">Cerrada</h6>
<small class="text-muted">Falla cerrada definitivamente</small>
</div>
</div>
</div>
</div>
</div>

<-- Historial de ediciones -->
<div class="card">
<div class="card-header">
<h6 class="mb-0">
<i class="bi bi-clock-history"></i> Historial de Ediciones
</h6>
</div>
<div class="card-body">
<div class="historial-ediciones p-3">
<div class="cambio-item">
<small class="text-muted">{{ falla.fecha_modificacion.strftime('%d/%m/%Y %H:%M') if falla.fecha_modificacion else falla.fecha_reporte.strftime('%d/%m/%Y %H:%M') }}</small>
<div><strong>Creación de la falla</strong></div>
<small class="text-muted">Reportado por {{ falla.usuario_reporta.nombre_completo if falla.usuario_reporta else 'Sistema' }}</small>
</div>

{% if falla.historial_cambios %}
{% for cambio in falla.historial_cambios[-5:] %}
<div class="cambio-item {% if cambio.gravedad == 'critica' %}critico{% endif %}">
<small class="text-muted">{{ cambio.fecha.strftime('%d/%m/%Y %H:%M') }}</small>
<div><strong>{{ cambio.tipo_cambio.title() }}</strong></div>
<small class="text-muted">{{ cambio.descripcion }}</small>
</div>
{% endfor %}
{% endif %}
</div>
</div>
</div>
</div>
</div>

<-- Botones de acción -->
<div class="row mt-4">
<div class="col-1">
<div class="d-flex justify-content-between">
<a href="{{ url_for('fallas_detalle', falla_id=falla.id) }}" class="btn btn-outline-secondary">
<i class="bi bi-x-circle"></i> Cancelar
</a>

<div>
<button type="button" class="btn btn-info me-" onclick="vistaPrevia()">
<i class="bi bi-eye"></i> Vista Previa
</button>
<button type="submit" class="btn btn-primary">
<i class="bi bi-check-circle"></i> Guardar Cambios
</button>
</div>
</div>
</div>
</div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
// Contador de caracteres
const descripcion = document.getElementById('descripcion');
const solucion = document.getElementById('solucion');
const comentarios = document.getElementById('comentarios');
const charCount = document.getElementById('char-count');
const solucionCount = document.getElementById('solucion-count');
const comentariosCount = document.getElementById('comentarios-count');

function actualizarContador(textarea, counter, maxLength) {
counter.textContent = textarea.value.length;
if (textarea.value.length > maxLength) {
textarea.value = textarea.value.substring(0, maxLength);
counter.textContent = maxLength;
}
}

descripcion.addEventListener('input', () => actualizarContador(descripcion, charCount, 500));
solucion.addEventListener('input', () => actualizarContador(solucion, solucionCount, 500));
comentarios.addEventListener('input', () => actualizarContador(comentarios, comentariosCount, 300));

// Selección visual de gravedad
const gravedadOptions = document.querySelectorAll('.gravedad-option');
const gravedadSelect = document.getElementById('gravedad');

gravedadOptions.forEach(option => {
option.addEventListener('click', function() {
gravedadOptions.forEach(opt => opt.classList.remove('selected'));
this.classList.add('selected');
gravedadSelect.value = this.dataset.gravedad;
});
});

// Selección visual de estado
const estadoOptions = document.querySelectorAll('.estado-option');
const estadoSelect = document.getElementById('estado');

estadoOptions.forEach(option => {
option.addEventListener('click', function() {
estadoOptions.forEach(opt => opt.classList.remove('selected'));
this.classList.add('selected');
estadoSelect.value = this.dataset.estado;
});
});

// Upload zone
const uploadZone = document.getElementById('upload-zone');
const evidenciasInput = document.getElementById('evidencias');
const previewContainer = document.getElementById('preview-evidencias');

uploadZone.addEventListener('click', () => evidenciasInput.click());

uploadZone.addEventListener('dragover', (e) => {
e.preventDefault();
uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
e.preventDefault();
uploadZone.classList.remove('dragover');
evidenciasInput.files = e.dataTransfer.files;
mostrarPreviewEvidencias();
});

evidenciasInput.addEventListener('change', mostrarPreviewEvidencias);

function mostrarPreviewEvidencias() {
previewContainer.innerHTML = '';
const files = evidenciasInput.files;

for (let i = 0; i < files.length; i++) {
const file = files[i];
if (file.type.startsWith('image/')) {
const reader = new FileReader();
reader.onload = (e) => {
const col = document.createElement('div');
col.className = 'col-md-3 mb-';
col.innerHTML = `
<div class="card">
<img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
<div class="card-body p-">
<small class="text-muted">${file.name.substring(0, 0)}...</small>
</div>
</div>
`;
previewContainer.appendChild(col);
};
reader.readAsDataURL(file);
}
}
}

// Vista previa
window.vistaPrevia = function() {
const form = document.getElementById('formFalla');
const formData = new FormData(form);

// Crear ventana de vista previa
const previewWindow = window.open('', '_blank', 'width=800,height=600');
const data = Object.fromEntries(formData.entries());

previewWindow.document.write(`
<html>
<head>
<title>Vista Previa - Falla #{{ falla.id }}</title>
<style>
body { font-family: Arial, sans-serif; margin: 0px; }
.header { background: #f8f9fa; padding: 0px; border-radius: 8px; margin-bottom: 0px; }
.section { margin-bottom: 0px; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 1px; }
</style>
</head>
<body>
<div class="header">
<h1>Falla #{{ falla.id }} - Vista Previa</h1>
<p>Esta es una vista previa de cómo se verá la falla después de guardar los cambios.</p>
</div>

<div class="section">
<h3>Información Básica</h3>
<p><strong>Equipo:</strong> ${document.getElementById('equipo_id').selectedOptions[0].text}</p>
<p><strong>Estado:</strong> <span class="badge bg-secondary">${data.estado || 'No seleccionado'}</span></p>
<p><strong>Gravedad:</strong> <span class="badge bg-danger">${data.gravedad || 'No seleccionada'}</span></p>
</div>

<div class="section">
<h3>Descripción</h3>
<p>${data.descripcion || 'Sin descripción'}</p>
</div>

${data.solucion ? `
<div class="section">
<h3>Solución</h3>
<p>${data.solucion}</p>
</div>
` : ''}

${data.costo ? `
<div class="section">
<h3>Costo</h3>
<p><strong>$${parseFloat(data.costo).toFixed()}</strong></p>
</div>
` : ''}

<div class="section">
<button onclick="window.print()">Imprimir</button>
<button onclick="window.close()">Cerrar</button>
</div>
</body>
</html>
`);
};
});
</script>
{% endblock %}