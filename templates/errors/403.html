{% extends 'base.html' %}

{% block title %}Acceso Denegado (403) - Sistema de Gestión Académica UFRO{% endblock %}

{% block content %}
<div class="container">
<div class="row justify-content-center align-items-center min-vh-100">
<div class="col-md-6 text-center">
<-- Icono de acceso denegado -->
<div class="mb-4">
<i class="bi bi-shield-lock-fill text-danger" style="font-size: 8rem;"></i>
</div>

<-- Título del error -->
<h1 class="display-1 fw-bold text-danger mb-3">403</h1>

<-- Mensaje principal -->
<h class="h3 mb-3">Acceso Denegado</h>

<-- Descripción del error -->
<p class="lead text-muted mb-4">
No tienes permisos suficientes para acceder a este recurso.
Tu nivel de acceso no permite realizar esta acción o visitar esta página.
</p>

<-- Información del usuario y permisos -->
<div class="alert alert-info" role="alert">
<h5 class="alert-heading">
<i class="bi bi-person-badge me-"></i>Información de Acceso
</h5>
<div class="row text-start">
<div class="col-md-6">
<p class="mb-"><strong>Usuario:</strong> {{ user.get_full_name|default:user.username }}</p>
<p class="mb-"><strong>Email:</strong> {{ user.email }}</p>
<p class="mb-0"><strong>Estado:</strong>
{% if user.is_active %}
<span class="badge bg-success">Activo</span>
{% else %}
<span class="badge bg-danger">Inactivo</span>
{% endif %}
</p>
</div>
<div class="col-md-6">
<p class="mb-"><strong>Rol:</strong>
<span class="badge bg-{{ user.perfil.rol_color|default:'secondary' }}">
{{ user.perfil.rol|default:"No definido"|title }}
</span>
</p>
<p class="mb-"><strong>Departamento:</strong> {{ user.perfil.departamento|default:"No especificado" }}</p>
<p class="mb-0"><strong>Último acceso:</strong> {{ user.last_login|default:"No registrado"|timesince }}</p>
</div>
</div>
</div>

<-- Permisos requeridos vs actuales -->
<div class="mb-4">
<div class="row g-3">
<div class="col-md-6">
<div class="card content-card border-success">
<div class="card-header bg-success bg-opacity-10">
<h6 class="card-title mb-0 text-success">
<i class="bi bi-check-circle me-"></i>Tus Permisos Actuales
</h6>
</div>
<div class="card-body text-start">
<ul class="list-unstyled small mb-0">
{% for permiso in permisos_usuario %}
<li><i class="bi bi-check text-success me-"></i>{{ permiso }}</li>
{% empty %}
<li><i class="bi bi-dash text-muted me-"></i>Permisos básicos</li>
{% endfor %}
</ul>
</div>
</div>
</div>

<div class="col-md-6">
<div class="card content-card border-danger">
<div class="card-header bg-danger bg-opacity-10">
<h6 class="card-title mb-0 text-danger">
<i class="bi bi-exclamation-triangle me-"></i>Permisos Requeridos
</h6>
</div>
<div class="card-body text-start">
<ul class="list-unstyled small mb-0">
{% for permiso in permisos_requeridos %}
<li><i class="bi bi-x-circle text-danger me-"></i>{{ permiso }}</li>
{% empty %}
<li><i class="bi bi-question-circle text-muted me-"></i>Acceso de administrador requerido</li>
{% endfor %}
</ul>
</div>
</div>
</div>
</div>
</div>

<-- Acciones recomendadas -->
<div class="mb-5">
<h5 class="mb-3">¿Qué puedes hacer?</h5>
<div class="row g-3">
<div class="col-md-4">
<div class="card content-card h-100 border-primary">
<div class="card-body text-center">
<i class="bi bi-house fs-1 text-primary mb-"></i>
<h6 class="card-title">Ir al Dashboard</h6>
<p class="card-text small">Volver a tu área de trabajo</p>
<a href="{% url 'dashboard' %}" class="btn btn-primary btn-sm">
<i class="bi bi-house me-1"></i>Dashboard
</a>
</div>
</div>
</div>

<div class="col-md-4">
<div class="card content-card h-100 border-info">
<div class="card-body text-center">
<i class="bi bi-person-check fs-1 text-info mb-"></i>
<h6 class="card-title">Solicitar Acceso</h6>
<p class="card-text small">Contactar al administrador</p>
<button class="btn btn-info btn-sm" onclick="solicitarAcceso()">
<i class="bi bi-plus-circle me-1"></i>Solicitar
</button>
</div>
</div>
</div>

<div class="col-md-4">
<div class="card content-card h-100 border-warning">
<div class="card-body text-center">
<i class="bi bi-question-circle fs-1 text-warning mb-"></i>
<h6 class="card-title">Ver Ayuda</h6>
<p class="card-text small">Entender los permisos</p>
<button class="btn btn-warning btn-sm" onclick="mostrarAyuda()">
<i class="bi bi-question-circle me-1"></i>Ayuda
</button>
</div>
</div>
</div>
</div>
</div>

<-- Roles y permisos del sistema -->
<div class="mb-4">
<div class="card content-card">
<div class="card-header bg-transparent">
<h5 class="card-title mb-0">
<i class="bi bi-people me-"></i>Roles del Sistema
</h5>
</div>
<div class="card-body">
<div class="row">
<div class="col-md-6">
<h6 class="text-muted mb-3">Descripción de Roles</h6>
<div class="small">
{% if user.perfil.rol == 'super_admin' %}
<div class="mb-">
<span class="badge bg-danger">SUPER ADMIN</span>
<span class="text-muted ms-">Control total del sistema</span>
</div>
{% endif %}

{% if user.perfil.rol == 'admin' or user.perfil.rol == 'super_admin' %}
<div class="mb-">
<span class="badge bg-warning">ADMINISTRADOR</span>
<span class="text-muted ms-">Gestión completa de usuarios y datos</span>
</div>
{% endif %}

<div class="mb-">
<span class="badge bg-info">PROFESOR</span>
<span class="text-muted ms-">Gestión de cursos y estudiantes</span>
</div>

<div class="mb-">
<span class="badge bg-success">ESTUDIANTE</span>
<span class="text-muted ms-">Acceso a matrículas y calificaciones</span>
</div>
</div>
</div>

<div class="col-md-6">
<h6 class="text-muted mb-3">Permisos por Acción</h6>
<div class="small">
<div class="mb-">
<strong>Usuarios:</strong>
<span class="text-muted">
{% if user.perfil.rol == 'admin' or user.perfil.rol == 'super_admin' %}
Completo
{% else %}
Solo lectura
{% endif %}
</span>
</div>
<div class="mb-">
<strong>Carreras:</strong>
<span class="text-muted">
{% if user.perfil.rol == 'admin' or user.perfil.rol == 'super_admin' %}
Completo
{% else %}
Lectura
{% endif %}
</span>
</div>
<div class="mb-">
<strong>Informes:</strong>
<span class="text-muted">
{% if user.perfil.rol == 'admin' or user.perfil.rol == 'super_admin' or user.perfil.rol == 'profesor' %}
Completo
{% else %}
Básico
{% endif %}
</span>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<-- Información de contacto -->
<div class="row g-3">
<div class="col-md-6">
<div class="card content-card h-100">
<div class="card-body">
<h6 class="text-primary mb-3">
<i class="bi bi-envelope me-"></i>Solicitar Permisos
</h6>
<p class="small mb-3">
Si necesitas acceso adicional, contacta a tu supervisor directo o al administrador del sistema.
</p>
<ul class="list-unstyled small">
<li class="mb-">
<i class="bi bi-person me-"></i>
<span>Administrador: admin.sistema@ufrontera.cl</span>
</li>
<li class="mb-">
<i class="bi bi-building me-"></i>
<span>Departamento de TI: soporte.seguridad@ufrontera.cl</span>
</li>
<li class="mb-">
<i class="bi bi-telephone me-"></i>
<span>+56 45 0 5000</span>
</li>
</ul>
</div>
</div>
</div>

<div class="col-md-6">
<div class="card content-card h-100">
<div class="card-body">
<h6 class="text-success mb-3">
<i class="bi bi-shield-check me-"></i>Seguridad
</h6>
<p class="small mb-3">
Este control de acceso protege la información confidencial del sistema.
</p>
<ul class="list-unstyled small">
<li class="mb-">
<i class="bi bi-lock me-"></i>
<span>Todos los accesos son auditados</span>
</li>
<li class="mb-">
<i class="bi bi-clock me-"></i>
<span>Historial de intentos de acceso</span>
</li>
<li class="mb-">
<i class="bi bi-eye me-"></i>
<span>Monitoreo 4/7 de seguridad</span>
</li>
</ul>
</div>
</div>
</div>
</div>

<-- Código de error y detalles -->
<div class="mt-4 p-3 bg-light rounded">
<h6 class="text-muted mb-">Detalles del Error 403</h6>
<p class="small text-muted mb-">
<strong>Código:</strong> 403 Forbidden<br>
<strong>Recurso:</strong> {{ requested_resource|default:"Página solicitada" }}<br>
<strong>Timestamp:</strong> {{ timestamp|default:"Ahora" }}<br>
<strong>Session ID:</strong> {{ session_id|default:"No disponible" }}
</p>
<p class="small text-muted mb-0">
Este error indica que el servidor entendió la solicitud pero se niega a autorizarla.
Para más información sobre tu nivel de acceso, consulta con el administrador del sistema.
</p>
</div>
</div>
</div>
</div>

<-- Modal de solicitud de acceso -->
<div class="modal fade" id="accessModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
<i class="bi bi-shield-plus me-"></i>Solicitar Acceso
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="accessRequestForm">
<div class="mb-3">
<label class="form-label">Tipo de Acceso Solicitado</label>
<select class="form-select" name="access_type" required>
<option value="">Seleccionar tipo</option>
<option value="admin">Acceso de Administrador</option>
<option value="profesor">Gestión de Cursos</option>
<option value="reportes">Informes Avanzados</option>
<option value="usuarios">Gestión de Usuarios</option>
<option value="otro">Otro (especificar)</option>
</select>
</div>

<div class="mb-3">
<label class="form-label">Justificación</label>
<textarea class="form-control"
name="justification"
rows="3"
placeholder="Describe por qué necesitas este acceso..."
required></textarea>
</div>

<div class="mb-3">
<label class="form-label">Supervisor/Responsable</label>
<input type="email"
class="form-control"
name="supervisor_email"
placeholder="email@ufrontera.cl"
required>
<div class="form-text">Email de tu supervisor directo</div>
</div>

<div class="form-check">
<input class="form-check-input"
type="checkbox"
name="acknowledge"
id="acknowledgeCheck"
required>
<label class="form-check-label" for="acknowledgeCheck">
Acepto los términos de uso y confirmo que esta solicitud es legítima
</label>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary" onclick="submitAccessRequest()">
<i class="bi bi-send me-"></i>Enviar Solicitud
</button>
</div>
</div>
</div>
</div>

<-- Modal de ayuda -->
<div class="modal fade" id="helpModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
<i class="bi bi-question-circle me-"></i>Ayuda sobre Permisos
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<h6>¿Qué significa "Acceso Denegado"?</h6>
<p>Este mensaje aparece cuando intentas acceder a una función o página para la cual no tienes los permisos necesarios.</p>

<h6>Tipos de roles en el sistema:</h6>
<ul>
<li><strong>Estudiante:</strong> Puede ver sus propias matrículas, calificaciones y horario</li>
<li><strong>Profesor:</strong> Puede gestionar sus cursos y ver información de sus estudiantes</li>
<li><strong>Administrador:</strong> Puede gestionar usuarios, carreras y asignaturas</li>
<li><strong>Super Administrador:</strong> Control total del sistema</li>
</ul>

<h6>¿Cómo obtener más permisos?</h6>
<p>Contacta a tu supervisor directo o al administrador del sistema para solicitar un cambio en tu nivel de acceso.</p>
</div>
</div>
</div>
</div>

<style>
.min-vh-100 {
min-height: 100vh;
}

.card {
transition: transform 0.s ease-in-out;
}

.card:hover {
transform: translateY(-px);
}

.btn:hover {
transform: translateY(-1px);
}

code {
background-color: #f8f9fa;
padding: px 4px;
border-radius: 3px;
font-size: 0.875em;
}
</style>

<script>
// Función para solicitar acceso
function solicitarAcceso() {
new bootstrap.Modal(document.getElementById('accessModal')).show();
}

// Función para mostrar ayuda
function mostrarAyuda() {
new bootstrap.Modal(document.getElementById('helpModal')).show();
}

// Función para enviar solicitud de acceso
function submitAccessRequest() {
const form = document.getElementById('accessRequestForm');
const formData = new FormData(form);

// Validar formulario
if (form.checkValidity()) {
form.reportValidity();
return;
}

const button = event.target;
const originalText = button.innerHTML;

// Mostrar loading
button.innerHTML = '<span class="spinner-border spinner-border-sm me-"></span>Enviando...';
button.disabled = true;

// Crear datos de la solicitud
const requestData = {
user_id: '{{ user.id }}',
access_type: formData.get('access_type'),
justification: formData.get('justification'),
supervisor_email: formData.get('supervisor_email'),
timestamp: new Date().toISOString(),
requested_resource: '{{ requested_resource|default:"N/A" }}'
};

// Simular envío de solicitud
setTimeout(() => {
console.log('Enviando solicitud de acceso:', requestData);

// Aquí se enviaría al servidor
// fetch('/api/access-request/', {
// method: 'POST',
// headers: { 'Content-Type': 'application/json' },
// body: JSON.stringify(requestData)
// });

// Cerrar modal
bootstrap.Modal.getInstance(document.getElementById('accessModal')).hide();

// Mostrar confirmación
alert('Solicitud de acceso enviada exitosamente. Recibirás una respuesta por email.');

// Restaurar botón
button.innerHTML = originalText;
button.disabled = false;

// Limpiar formulario
form.reset();
}, 000);
}

// Auto-redireccionar después de un tiempo si es una sesión caducada
setTimeout(() => {
if (confirm('Tu sesión podría haber expirado. ¿Deseas volver al dashboard para verificar tu estado?')) {
window.location.href = "{% url 'dashboard' %}";
}
}, 60000); // 1 minuto

// Tracking para analytics
if (typeof gtag == 'undefined') {
gtag('event', 'exception', {
'description': '403 Access Denied',
'fatal': false,
'custom_map': {
'user_role': '{{ user.perfil.rol|default:"unknown" }}',
'requested_resource': '{{ requested_resource|default:"unknown" }}'
}
});
}

// Log del intento de acceso para auditoría
const accessAttempt = {
timestamp: new Date().toISOString(),
user_id: '{{ user.id }}',
user_role: '{{ user.perfil.rol|default:"unknown" }}',
requested_resource: '{{ requested_resource|default:"unknown" }}',
user_agent: navigator.userAgent,
ip_address: '{{ client_ip|default:"unknown" }}'
};

console.log('Registro de intento de acceso denegado:', accessAttempt);

// Enviar log de acceso (simulado)
fetch('/api/access-log/', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(accessAttempt)
}).catch(error => {
console.log('Error enviando log de acceso (esperado en este entorno)');
});
</script>

{% endblock %}