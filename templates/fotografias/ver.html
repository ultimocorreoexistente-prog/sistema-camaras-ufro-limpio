{% extends "base.html" %}

{% block title %}Ver Fotografía - Sistema Cámaras UFRO{% endblock %}

{% block extra_css %}
<style>
.fotografia-principal {
max-width: 100%;
height: auto;
border-radius: 1px;
box-shadow: 0 8px 5px rgba(0,0,0,0.15);
cursor: pointer;
transition: transform 0.3s ease;
}

.fotografia-principal:hover {
transform: scale(1.0);
}

.categoria-badge {
font-size: 1rem;
padding: 0.5rem 1rem;
border-radius: 5px;
}

.info-card {
background: white;
border-radius: 1px;
padding: 1.5rem;
box-shadow: 0 4px 6px rgba(0,0,0,0.07);
margin-bottom: 1.5rem;
border-left: 4px solid #007bff;
}

.metadata-section {
background: #f8f9fa;
border-radius: 8px;
padding: 1rem;
margin-bottom: 1rem;
}

.lightbox {
display: none;
position: fixed;
z-index: 000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.95);
}

.lightbox-content {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
max-width: 95%;
max-height: 95%;
}

.lightbox img {
width: 100%;
height: auto;
border-radius: 8px;
}

.lightbox-close {
position: absolute;
top: 15px;
right: 5px;
color: white;
font-size: 35px;
font-weight: bold;
cursor: pointer;
z-index: 001;
}

.lightbox-info {
position: absolute;
bottom: 0px;
left: 0px;
right: 0px;
background: rgba(0,0,0,0.8);
color: white;
padding: 15px;
border-radius: 8px;
text-align: center;
}

.equipo-conexion {
background: linear-gradient(135deg, #667eea 0%, #764ba 100%);
color: white;
border-radius: 1px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}

.timeline-item {
position: relative;
padding-left: 30px;
margin-bottom: 0px;
}

.timeline-item:before {
content: '';
position: absolute;
left: 8px;
top: 8px;
width: 1px;
height: 1px;
border-radius: 50%;
background: #007bff;
}

.timeline-item:after {
content: '';
position: absolute;
left: 13px;
top: 0px;
width: px;
height: calc(100% - 1px);
background: #deee6;
}

.timeline-item:last-child:after {
display: none;
}

.action-buttons {
position: sticky;
top: 0px;
z-index: 100;
}

.related-photos {
background: white;
border-radius: 1px;
padding: 1.5rem;
box-shadow: 0 4px 6px rgba(0,0,0,0.07);
}

.related-photo-thumb {
width: 100px;
height: 100px;
object-fit: cover;
border-radius: 8px;
cursor: pointer;
transition: transform 0.s ease;
border: px solid transparent;
}

.related-photo-thumb:hover {
transform: scale(1.05);
border-color: #007bff;
}

.download-options {
background: #e3ffd;
border-left: 4px solid #196f3;
padding: 15px;
border-radius: 8px;
}

@media (max-width: 768px) {
.info-card {
padding: 1rem;
}

.equipo-conexion {
padding: 1rem;
}

.action-buttons {
position: relative;
top: 0;
}
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
<div class="row">
<div class="col-1">
<div class="d-flex justify-content-between align-items-center mb-4">
<div>
<h><i class="bi bi-eye"></i> Detalles de Fotografía</h>
<nav aria-label="breadcrumb">
<ol class="breadcrumb">
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('fotografias_listar') }}">Fotografías</a></li>
<li class="breadcrumb-item active">ID #{{ fotografia.id }}</li>
</ol>
</nav>
</div>
<a href="{{ url_for('fotografias_listar') }}" class="btn btn-secondary">
<i class="bi bi-arrow-left"></i> Volver a Lista
</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
{{ message }}
<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row">
<-- Columna principal - Fotografía -->
<div class="col-lg-8">
<div class="info-card">
<div class="d-flex justify-content-between align-items-center mb-3">
<h4 class="mb-0">
<i class="bi bi-camera-fill"></i> Fotografía de Intervención
</h4>
<div>
{% if fotografia.categoria == 'Antes' %}
<span class="badge categoria-badge bg-danger">Antes de Intervención</span>
{% elif fotografia.categoria == 'Durante' %}
<span class="badge categoria-badge bg-warning">Durante Intervención</span>
{% elif fotografia.categoria == 'Después' %}
<span class="badge categoria-badge bg-success">Después de Intervención</span>
{% endif %}
</div>
</div>

<div class="text-center">
<img src="{{ url_for('fotografias_archivo', filename=fotografia.nombre_archivo) }}"
class="fotografia-principal"
alt="{{ fotografia.descripcion or 'Fotografía de intervención' }}"
onclick="abrirLightbox()">
<div class="mt-3">
<small class="text-muted">
<i class="bi bi-info-circle"></i> Haz clic en la imagen para verla en tamaño completo
</small>
</div>
</div>
</div>

<-- Descripción detallada -->
<div class="info-card">
<h5><i class="bi bi-textarea-t"></i> Descripción de la Intervención</h5>
<p class="lead">{{ fotografia.descripcion or 'Sin descripción proporcionada.' }}</p>
</div>

<-- Información del equipo -->
<div class="equipo-conexion">
<h5><i class="bi bi-gear-fill"></i> Equipo Intervenido</h5>
<div class="row align-items-center">
<div class="col-md-8">
<h6>{{ fotografia.equipo_tipo }} - ID: {{ fotografia.equipo_id }}</h6>
<p class="mb-0">
{% if fotografia.equipo_tipo == 'Camara' %}
<i class="bi bi-camera-video"></i> Cámara de Seguridad IP
{% elif fotografia.equipo_tipo == 'Switch' %}
<i class="bi bi-hdd-network"></i> Switch de Red
{% elif fotografia.equipo_tipo == 'Ups' %}
<i class="bi bi-battery-charging"></i> Sistema UPS
{% elif fotografia.equipo_tipo == 'Nvr_dvr' %}
<i class="bi bi-tv"></i> Sistema NVR/DVR
{% else %}
<i class="bi bi-gear"></i> {{ fotografia.equipo_tipo }}
{% endif %}
</p>
</div>
<div class="col-md-4 text-end">
<button class="btn btn-outline-light" onclick="verEquipo('{{ fotografia.equipo_tipo }}', {{ fotografia.equipo_id }})">
<i class="bi bi-search"></i> Ver Equipo
</button>
</div>
</div>
</div>

<-- Falla relacionada (si existe) -->
{% if fotografia.falla %}
<div class="info-card">
<h5><i class="bi bi-exclamation-triangle"></i> Falla Relacionada</h5>
<div class="d-flex justify-content-between align-items-center">
<div>
<h6>{{ fotografia.falla.codigo }}</h6>
<p class="mb-0">{{ fotografia.falla.descripcion }}</p>
<small class="text-muted">
Estado:
{% if fotografia.falla.estado == 'Pendiente' %}
<span class="badge bg-warning">{{ fotografia.falla.estado }}</span>
{% elif fotografia.falla.estado == 'En Proceso' %}
<span class="badge bg-info">{{ fotografia.falla.estado }}</span>
{% elif fotografia.falla.estado == 'Reparada' %}
<span class="badge bg-success">{{ fotografia.falla.estado }}</span>
{% else %}
<span class="badge bg-secondary">{{ fotografia.falla.estado }}</span>
{% endif %}
</small>
</div>
<div>
<button class="btn btn-outline-primary" onclick="verFalla({{ fotografia.falla.id }})">
<i class="bi bi-eye"></i> Ver Falla
</button>
</div>
</div>
</div>
{% endif %}
</div>

<-- Columna lateral - Información y acciones -->
<div class="col-lg-4">
<-- Acciones principales -->
<div class="action-buttons">
<div class="info-card">
<h6><i class="bi bi-tools"></i> Acciones</h6>
<div class="d-grid gap-">
<button class="btn btn-primary" onclick="abrirLightbox()">
<i class="bi bi-zoom-in"></i> Ver en Pantalla Completa
</button>
<button class="btn btn-outline-success" onclick="descargarFotografia()">
<i class="bi bi-download"></i> Descargar Imagen
</button>
{% if current_user.rol.upper() in ['SUPERADMIN', 'ADMIN'] or (current_user.rol.upper() == 'TECNICO' and fotografia.tecnico_id == current_user.id) %}
<button class="btn btn-outline-info" onclick="compartirFotografia()">
<i class="bi bi-share"></i> Compartir
</button>
{% endif %}
{% if current_user.rol.upper() in ['SUPERADMIN', 'ADMIN'] %}
<hr>
<button class="btn btn-outline-danger" onclick="eliminarFotografia()">
<i class="bi bi-trash"></i> Eliminar
</button>
{% endif %}
</div>
</div>
</div>

<-- Metadatos de la fotografía -->
<div class="info-card">
<h6><i class="bi bi-info-circle"></i> Información de la Fotografía</h6>
<div class="metadata-section">
<div class="row mb-">
<div class="col-5"><strong>ID:</strong></div>
<div class="col-7">#{{ fotografia.id }}</div>
</div>
<div class="row mb-">
<div class="col-5"><strong>Técnico:</strong></div>
<div class="col-7">
{% if fotografia.tecnico %}
<i class="bi bi-person"></i> {{ fotografia.tecnico.nombre_completo or fotografia.tecnico.nombre }}
{% else %}
<span class="text-muted">Sin asignar</span>
{% endif %}
</div>
</div>
<div class="row mb-">
<div class="col-5"><strong>Fecha:</strong></div>
<div class="col-7">
<i class="bi bi-calendar"></i> {{ fotografia.fecha_subida.strftime('%d/%m/%Y') }}
</div>
</div>
<div class="row mb-">
<div class="col-5"><strong>Hora:</strong></div>
<div class="col-7">
<i class="bi bi-clock"></i> {{ fotografia.fecha_subida.strftime('%H:%M:%S') }}
</div>
</div>
<div class="row mb-">
<div class="col-5"><strong>Archivo:</strong></div>
<div class="col-7">
<small class="text-muted">{{ fotografia.nombre_archivo }}</small>
</div>
</div>
</div>
</div>

<-- Timeline de intervención -->
<div class="info-card">
<h6><i class="bi bi-clock-history"></i> Timeline de Intervención</h6>
<div class="timeline-item">
<h6 class="mb-1">Fotografía Registrada</h6>
<small class="text-muted">{{ fotografia.fecha_subida.strftime('%d/%m/%Y %H:%M') }}</small>
<p class="mb-0 small">{{ fotografia.categoria }} - {{ fotografia.descripcion[:50] }}{% if fotografia.descripcion|length > 50 %}...{% endif %}</p>
</div>

{% if fotografia.falla %}
<div class="timeline-item">
<h6 class="mb-1">Falla Reportada</h6>
<small class="text-muted">{{ fotografia.falla.fecha_reporte.strftime('%d/%m/%Y %H:%M') if fotografia.falla.fecha_reporte else 'Fecha no disponible' }}</small>
<p class="mb-0 small">{{ fotografia.falla.codigo }} - {{ fotografia.falla.descripcion[:50] }}{% if fotografia.falla.descripcion|length > 50 %}...{% endif %}</p>
</div>
{% endif %}

<div class="timeline-item">
<h6 class="mb-1">Equipo en Sistema</h6>
<small class="text-muted">Desde instalación inicial</small>
<p class="mb-0 small">{{ fotografia.equipo_tipo }} ID: {{ fotografia.equipo_id }}</p>
</div>
</div>

<-- Fotografías relacionadas -->
<div class="related-photos" id="related-photos" style="display: none;">
<h6><i class="bi bi-images"></i> Fotografías Relacionadas</h6>
<p class="small text-muted">Otras fotografías del mismo equipo</p>
<div class="row" id="related-photos-container">
<-- Se llena dinámicamente -->
</div>
</div>

<-- Opciones de descarga -->
<div class="download-options">
<h6><i class="bi bi-download"></i> Opciones de Descarga</h6>
<div class="d-grid gap-1">
<button class="btn btn-sm btn-outline-primary" onclick="descargarOriginal()">
<i class="bi bi-file-earmark-image"></i> Tamaño Original
</button>
<button class="btn btn-sm btn-outline-secondary" onclick="descargarComprimida()">
<i class="bi bi-file-earmark-zip"></i> Versión Comprimida
</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<-- Lightbox para pantalla completa -->
<div id="lightbox" class="lightbox" onclick="cerrarLightbox()">
<span class="lightbox-close" onclick="cerrarLightbox()">&times;</span>
<div class="lightbox-content">
<img id="lightbox-img"
src="{{ url_for('fotografias_archivo', filename=fotografia.nombre_archivo) }}"
alt="{{ fotografia.descripcion or 'Fotografía de intervención' }}">
<div class="lightbox-info">
<h5>{{ fotografia.categoria }} - {{ fotografia.equipo_tipo }} ID: {{ fotografia.equipo_id }}</h5>
<p>{{ fotografia.descripcion or 'Sin descripción' }}</p>
<small>{{ fotografia.tecnico.nombre_completo if fotografia.tecnico else 'Sin técnico asignado' }} - {{ fotografia.fecha_subida.strftime('%d/%m/%Y %H:%M') }}</small>
</div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
cargarFotografiasRelacionadas();
});

// Funciones del lightbox
function abrirLightbox() {
document.getElementById('lightbox').style.display = 'block';
document.body.style.overflow = 'hidden';
}

function cerrarLightbox() {
document.getElementById('lightbox').style.display = 'none';
document.body.style.overflow = 'auto';
}

// Cerrar lightbox con ESC
document.addEventListener('keydown', function(e) {
if (e.key === 'Escape') {
cerrarLightbox();
}
});

// Cargar fotografías relacionadas del mismo equipo
function cargarFotografiasRelacionadas() {
const equipoTipo = '{{ fotografia.equipo_tipo }}';
const equipoId = {{ fotografia.equipo_id }};
const fotoActualId = {{ fotografia.id }};

fetch(`/api/equipos/${equipoTipo.toLowerCase()}/${equipoId}/fotografias`)
.then(response => response.json())
.then(data => {
const fotografiasRelacionadas = data.filter(foto => foto.id == fotoActualId);

if (fotografiasRelacionadas.length > 0) {
mostrarFotografiasRelacionadas(fotografiasRelacionadas);
}
})
.catch(error => {
console.error('Error cargando fotografías relacionadas:', error);
});
}

function mostrarFotografiasRelacionadas(fotografias) {
const container = document.getElementById('related-photos-container');
container.innerHTML = '';

fotografias.slice(0, 6).forEach(foto => {
const col = document.createElement('div');
col.className = 'col-4 mb-';

col.innerHTML = `
<img src="${foto.archivo_url}"
class="related-photo-thumb w-100"
alt="${foto.descripcion}"
title="${foto.categoria} - ${foto.descripcion}"
onclick="verFotografia(${foto.id})">
<small class="text-center d-block mt-1">${foto.categoria}</small>
`;

container.appendChild(col);
});

document.getElementById('related-photos').style.display = 'block';
}

// Funciones de navegación
function verEquipo(tipo, id) {
// Redirigir a la página de detalles del equipo
console.log(`Ver ${tipo} ID: ${id}`);
alert(`Funcionalidad de ver ${tipo} en desarrollo...`);
}

function verFalla(id) {
// Redirigir a la página de detalles de la falla
console.log(`Ver falla ID: ${id}`);
alert('Funcionalidad de ver falla en desarrollo...');
}

function verFotografia(id) {
window.location.href = `/fotografias/ver/${id}`;
}

// Funciones de descarga
function descargarFotografia() {
const link = document.createElement('a');
link.href = '{{ url_for('fotografias_archivo', filename=fotografia.nombre_archivo) }}';
link.download = '{{ fotografia.nombre_archivo }}';
link.click();
}

function descargarOriginal() {
descargarFotografia();
}

function descargarComprimida() {
// En una implementación real, esto generaría una versión comprimida
alert('Descarga de versión comprimida en desarrollo...');
}

// Funciones de acción
function compartirFotografia() {
if (navigator.share) {
navigator.share({
title: 'Fotografía de Intervención - {{ fotografia.categoria }}',
text: '{{ fotografia.descripcion[:100] }}',
url: window.location.href
}).catch(error => console.error('Error compartiendo:', error));
} else {
// Fallback - copiar URL al clipboard
navigator.clipboard.writeText(window.location.href).then(() => {
alert('URL copiada al portapapeles');
});
}
}

function eliminarFotografia() {
if (confirm('¿Está seguro de que desea eliminar esta fotografía? Esta acción no se puede deshacer.')) {
// En una implementación real, esto haría una petición DELETE
alert('Funcionalidad de eliminación en desarrollo...');
}
}

// Función para detectar el tipo de dispositivo y optimizar la vista
function optimizarParaDispositivo() {
if (window.innerWidth < 768) {
// Móvil - ajustar lightbox
const lightboxContent = document.querySelector('.lightbox-content');
lightboxContent.style.maxWidth = '95%';
lightboxContent.style.maxHeight = '85%';
}
}

// Ejecutar optimización al cargar y al redimensionar
window.addEventListener('load', optimizarParaDispositivo);
window.addEventListener('resize', optimizarParaDispositivo);

// Funciones de analytics (opcional)
function registrarVisualizacion() {
// Registrar que se visualizó la fotografía
console.log('Fotografía visualizada:', {{ fotografia.id }});
}

// Registrar visualización al cargar la página
document.addEventListener('DOMContentLoaded', registrarVisualizacion);
</script>
{% endblock %}