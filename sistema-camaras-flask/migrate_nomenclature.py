#!/usr/bin/env python3
"""
Script de migraci√≥n de nomenclatura: usuario ‚Üí usuarios
Fecha: 2025-10-27 09:52:20
Descripci√≥n: Migra la base de datos para unificar nomenclatura de tablas

USO:
1. Ejecutar: python migrate_nomenclature.py
2. O v√≠a endpoint HTTP: POST /admin/migrate-nomenclature

SEGURIDAD:
- Solo ejecutar cuando no haya usuarios activos en el sistema
- Hacer backup de la BD antes de ejecutar
- Verificar que todas las foreign keys est√°n correctamente actualizadas
"""

import os
import sys
from sqlalchemy import text
from models import db, Usuario

def migrate_usuario_to_usuarios():
    """
    Migra la tabla usuario a usuarios de manera segura
    """
    try:
        print("üîÑ Iniciando migraci√≥n usuario ‚Üí usuarios...")
        
        # Verificar conexi√≥n
        with db.engine.connect() as conn:
            # Verificar que la tabla 'usuario' existe
            result = conn.execute(text("""
                SELECT EXISTS (
                    SELECT FROM information_schema.tables 
                    WHERE table_name = 'usuario'
                )
            """))
            usuario_exists = result.scalar()
            
            if not usuario_exists:
                print("‚ùå ERROR: La tabla 'usuario' no existe")
                return False
            
            # Verificar que no hay conflictos con 'usuarios'
            result = conn.execute(text("""
                SELECT EXISTS (
                    SELECT FROM information_schema.tables 
                    WHERE table_name = 'usuarios'
                )
            """))
            usuarios_exists = result.scalar()
            
            if usuarios_exists:
                print("‚ö†Ô∏è ADVERTENCIA: La tabla 'usuarios' ya existe")
                print("Abortando migraci√≥n para evitar p√©rdida de datos")
                return False
            
            print("‚úÖ Verificaciones previas completadas")
            
            # Ejecutar migraci√≥n en transacci√≥n
            with conn.begin():
                # Renombrar tabla
                conn.execute(text("ALTER TABLE usuario RENAME TO usuarios"))
                print("‚úÖ Tabla renombrada: usuario ‚Üí usuarios")
                
                # Actualizar foreign keys constraints
                print("üîÑ Actualizando foreign keys...")
                
                # Buscar y actualizar constraints
                constraints_query = text("""
                    SELECT conname, relname, a.attname 
                    FROM pg_constraint c
                    JOIN pg_class t ON t.oid = c.conrelid  
                    JOIN pg_attribute a ON a.attrelid = t.oid 
                    WHERE c.contype = 'f' 
                    AND pg_get_constraintdef(c.oid) LIKE '%usuario.id%'
                """)
                
                constraints = conn.execute(constraints_query).fetchall()
                
                for conname, table_name, column_name in constraints:
                    try:
                        # Eliminar constraint antiguo
                        conn.execute(text(f"ALTER TABLE {table_name} DROP CONSTRAINT IF EXISTS {conname}"))
                        
                        # Crear nuevo constraint
                        new_name = conname.replace('usuario', 'usuarios')
                        conn.execute(text(f"""
                            ALTER TABLE {table_name} 
                            ADD CONSTRAINT {new_name} 
                            FOREIGN KEY ({column_name}) REFERENCES usuarios(id)
                        """))
                        
                        print(f"‚úÖ Constraint actualizado: {conname} ‚Üí {new_name}")
                        
                    except Exception as e:
                        print(f"‚ö†Ô∏è Error con constraint {conname}: {e}")
                        # Continuar con otros constraints
                
                # Verificar integridad
                result = conn.execute(text("SELECT COUNT(*) FROM usuarios"))
                user_count = result.scalar()
                print(f"‚úÖ Migraci√≥n exitosa: {user_count} usuarios preservados")
            
            return True
            
    except Exception as e:
        print(f"‚ùå Error durante la migraci√≥n: {e}")
        return False

def verify_migration():
    """
    Verifica que la migraci√≥n fue exitosa
    """
    try:
        with db.engine.connect() as conn:
            # Verificar que usuarios existe y usuario no
            usuario_check = conn.execute(text("SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'usuario')")).scalar()
            usuarios_check = conn.execute(text("SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'usuarios')")).scalar()
            
            print(f"Tabla 'usuario' existe: {usuario_check}")
            print(f"Tabla 'usuarios' existe: {usuarios_check}")
            
            if not usuario_check and usuarios_check:
                print("‚úÖ Verificaci√≥n exitosa: migraci√≥n completada correctamente")
                return True
            else:
                print("‚ùå Verificaci√≥n fall√≥: la migraci√≥n no se complet√≥ correctamente")
                return False
                
    except Exception as e:
        print(f"‚ùå Error en verificaci√≥n: {e}")
        return False

if __name__ == "__main__":
    print("üö® MIGRACI√ìN DE NOMENCLATURA USUARIO ‚Üí USUARIOS")
    print("=" * 50)
    print("‚ö†Ô∏è IMPORTANTE: Aseg√∫rate de que:")
    print("   - El sistema est√© inactivo")
    print("   - Hayas hecho backup de la BD")
    print("   - No hay conexiones activas a la BD")
    print()
    
    confirm = input("¬øContinuar con la migraci√≥n? (yes/no): ").strip().lower()
    
    if confirm in ['yes', 'y', 's√≠', 's']:
        success = migrate_usuario_to_usuarios()
        
        if success:
            print("\nüéâ MIGRACI√ìN COMPLETADA EXITOSAMENTE")
            print("\nüìã PR√ìXIMOS PASOS:")
            print("1. Actualizar models.py: __tablename__ = 'usuarios'")
            print("2. Actualizar ForeignKey('usuarios.id') en models.py")
            print("3. Reiniciar la aplicaci√≥n")
            print("4. Verificar funcionalidades")
            
            verify = input("\n¬øVerificar migraci√≥n? (yes/no): ").strip().lower()
            if verify in ['yes', 'y', 's√≠', 's']:
                verify_migration()
                
        else:
            print("\n‚ùå MIGRACI√ìN FALL√ì")
            sys.exit(1)
    else:
        print("Migraci√≥n cancelada por el usuario")
        sys.exit(0)